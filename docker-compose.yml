services:
  redis:
    image: redis:8.2-alpine
    container_name: ${REDIS_CONTAINER_NAME:-superset-redis}
    restart: unless-stopped
    volumes:
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - superset-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    image: postgres:16-alpine
    container_name: ${POSTGRES_CONTAINER_NAME:-superset-postgres}
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-superset}
      POSTGRES_USER: ${POSTGRES_USER:-superset}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-superset}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - superset-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-superset}"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - with-local-db

  superset:
    build:
      context: ./superset
      dockerfile: Dockerfile
    container_name: ${SUPERSET_CONTAINER_NAME:-superset-app}
    restart: unless-stopped
    environment:
      # Database Configuration
      DATABASE_DIALECT: ${DATABASE_DIALECT:-postgresql}
      DATABASE_USER: ${DATABASE_USER:-superset}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-superset}
      DATABASE_HOST: ${DATABASE_HOST:-postgres}
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_DB: ${DATABASE_DB:-superset}
      
      # Redis Configuration
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT_INTERNAL:-6379}
      
      # Superset Configuration
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY:-CHANGE_THIS_TO_A_COMPLEX_RANDOM_SECRET_KEY}
      SUPERSET_ENV: ${SUPERSET_ENV:-production}
      SUPERSET_LOAD_EXAMPLES: ${SUPERSET_LOAD_EXAMPLES:-no}
      
      # Language Configuration
      BABEL_DEFAULT_LOCALE: ${BABEL_DEFAULT_LOCALE:-ja}
      LANGUAGES: ${LANGUAGES:-ja,en}
      
      # Admin User
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@superset.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin}
      ADMIN_FIRSTNAME: ${ADMIN_FIRSTNAME:-Admin}
      ADMIN_LASTNAME: ${ADMIN_LASTNAME:-User}
    ports:
      - "${SUPERSET_PORT:-8088}:8088"
    volumes:
      - superset-home:/app/superset_home
      - ./superset/superset_config.py:/app/pythonpath/superset_config.py:ro
    networks:
      - superset-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${SUPERSET_PORT:-8088}/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  superset-network:
    driver: bridge
    name: ${NETWORK_NAME:-superset-network}

volumes:
  redis-data:
    name: ${REDIS_VOLUME_NAME:-superset-redis-data}
  postgres-data:
    name: ${POSTGRES_VOLUME_NAME:-superset-postgres-data}
  superset-home:
    name: ${SUPERSET_VOLUME_NAME:-superset-home}
